<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <link rel="icon" type="image/x-icon" href="http://design-pattern.ru/favicon.ico">
    <link rel="stylesheet" type="text/css" href="../css/commons.css">
    <link rel="search" type="application/opensearchdescription+xml" title="Поиск паттернов" href="../search.xml">
    <title>Паттерн Unit of Work - Единица работы. Описания паттернов проектирования. Паттерны проектирования. Design pattern ru</title>    <meta name="keywords" content="Описания паттернов проектирования, Паттерны проектирования, Design pattern ru, Паттерн Unit of Work" >    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
</head>
<body>
    <div id="wrapper">
        <div id="header">
            <p><a href="../index.html">Справочник &laquo;Паттерны проектирования&raquo;</a></p>
        </div>

		<div id="content">
            			<h1>Unit of Work <em>(Единица работы)</em></h1>
			<p><img src="../i/unit-of-work.gif" alt="Паттерн проектирования Unit of Work"></p>
			<p><span class="quot">Паттерн проектирования Unit of Work</span></p>
			<h2>Описание Unit of Work</h2>
			<p>Обслуживает набор объектов, изменяемых в бизнес-транзакции (бизнес-действии) и управляет записью изменений и разрешением проблем конкуренции данных.</p>
            <p>Когда необходимо писать и читать из БД, важно следить за тем, что вы изменили и если не изменили - не записывать данные в БД. Также необходимо вставлять данные о новых объектах и удалять данные о старых.</p>
            <p>Можно записывать в БД каждое изменение объекта, но это приведёт к большому количеству мелких запросов к БД, что закончится замедлением работы приложения. Более того, это требует держать открытую транзакцию всё время работы приложения, что непрактично, если приложение обрабатывает несколько запросов одновременно. Ситуация ещё хуже, если необходимо следить за чтением из и БД, чтобы избежать неконсистентного чтения.</p>
            <p>Реализация паттерна <acronym title="Паттерн Unit of Work (Единица работы)">Unit of Work</acronym> следит за всеми действиями приложения, которые могут изменить БД в рамках одного бизнес-действия. Когда бизнес-действие завершается, <acronym title="Паттерн Unit of Work (Единица работы)">Unit of Work</acronym> выявляет все изменения и вносит их в БД.</p>

<h2>Примеры реализации</h2>
<div class="code-snippet">
    <div class="code-snippet-header">
        <button class="code-snippet-tab" data-language="javascript">JavaScript</button>
        <button class="code-snippet-tab" data-language="cpp">C++</button>
        <button class="code-snippet-tab" data-language="go">Go</button>
        <button class="code-snippet-tab" data-language="python">Python</button>
        <button class="code-snippet-tab" data-language="php">PHP</button>
    </div>
    <div class="code-snippet-content">
        <button class="code-snippet-copy">Copy</button>
        
        <div class="code-snippet-panel" data-language="javascript">
            <pre><code>// Unit of Work Pattern in JavaScript
class UnitOfWork {
    constructor() {
        this.newObjects = new Set();
        this.dirtyObjects = new Set();
        this.removedObjects = new Set();
    }
    
    registerNew(obj) {
        this.newObjects.add(obj);
    }
    
    registerDirty(obj) {
        if (!this.newObjects.has(obj)) {
            this.dirtyObjects.add(obj);
        }
    }
    
    registerRemoved(obj) {
        this.removedObjects.add(obj);
        this.newObjects.delete(obj);
        this.dirtyObjects.delete(obj);
    }
    
    commit() {
        // Insert new objects
        for (const obj of this.newObjects) {
            this.insert(obj);
        }
        
        // Update dirty objects
        for (const obj of this.dirtyObjects) {
            this.update(obj);
        }
        
        // Delete removed objects
        for (const obj of this.removedObjects) {
            this.delete(obj);
        }
        
        this.clear();
    }
    
    insert(obj) {
        console.log(`Inserting: ${obj.constructor.name}`);
    }
    
    update(obj) {
        console.log(`Updating: ${obj.constructor.name}`);
    }
    
    delete(obj) {
        console.log(`Deleting: ${obj.constructor.name}`);
    }
    
    clear() {
        this.newObjects.clear();
        this.dirtyObjects.clear();
        this.removedObjects.clear();
    }
}

// Usage
const uow = new UnitOfWork();
const user = new User(1, 'John', 'john@example.com');
uow.registerNew(user);
uow.commit();</code></pre>
        </div>
        
        <div class="code-snippet-panel" data-language="cpp">
            <pre><code>// Unit of Work Pattern in C++
#include &lt;iostream&gt;
#include &lt;set&gt;
#include &lt;memory&gt;

class UnitOfWork {
private:
    std::set&lt;void*&gt; newObjects;
    std::set&lt;void*&gt; dirtyObjects;
    std::set&lt;void*&gt; removedObjects;
    
public:
    void registerNew(void* obj) {
        newObjects.insert(obj);
    }
    
    void registerDirty(void* obj) {
        if (newObjects.find(obj) == newObjects.end()) {
            dirtyObjects.insert(obj);
        }
    }
    
    void registerRemoved(void* obj) {
        removedObjects.insert(obj);
        newObjects.erase(obj);
        dirtyObjects.erase(obj);
    }
    
    void commit() {
        // Insert new objects
        for (auto obj : newObjects) {
            insert(obj);
        }
        
        // Update dirty objects
        for (auto obj : dirtyObjects) {
            update(obj);
        }
        
        // Delete removed objects
        for (auto obj : removedObjects) {
            remove(obj);
        }
        
        clear();
    }
    
private:
    void insert(void* obj) {
        std::cout &lt;&lt; "Inserting object" &lt;&lt; std::endl;
    }
    
    void update(void* obj) {
        std::cout &lt;&lt; "Updating object" &lt;&lt; std::endl;
    }
    
    void remove(void* obj) {
        std::cout &lt;&lt; "Removing object" &lt;&lt; std::endl;
    }
    
    void clear() {
        newObjects.clear();
        dirtyObjects.clear();
        removedObjects.clear();
    }
};</code></pre>
        </div>
        
        <div class="code-snippet-panel" data-language="go">
            <pre><code>// Unit of Work Pattern in Go
package main

import "fmt"

type UnitOfWork struct {
    newObjects    map[interface{}]bool
    dirtyObjects  map[interface{}]bool
    removedObjects map[interface{}]bool
}

func NewUnitOfWork() *UnitOfWork {
    return &UnitOfWork{
        newObjects:    make(map[interface{}]bool),
        dirtyObjects:  make(map[interface{}]bool),
        removedObjects: make(map[interface{}]bool),
    }
}

func (uow *UnitOfWork) RegisterNew(obj interface{}) {
    uow.newObjects[obj] = true
}

func (uow *UnitOfWork) RegisterDirty(obj interface{}) {
    if !uow.newObjects[obj] {
        uow.dirtyObjects[obj] = true
    }
}

func (uow *UnitOfWork) RegisterRemoved(obj interface{}) {
    uow.removedObjects[obj] = true
    delete(uow.newObjects, obj)
    delete(uow.dirtyObjects, obj)
}

func (uow *UnitOfWork) Commit() {
    // Insert new objects
    for obj := range uow.newObjects {
        uow.insert(obj)
    }
    
    // Update dirty objects
    for obj := range uow.dirtyObjects {
        uow.update(obj)
    }
    
    // Delete removed objects
    for obj := range uow.removedObjects {
        uow.delete(obj)
    }
    
    uow.clear()
}

func (uow *UnitOfWork) insert(obj interface{}) {
    fmt.Printf("Inserting: %T\n", obj)
}

func (uow *UnitOfWork) update(obj interface{}) {
    fmt.Printf("Updating: %T\n", obj)
}

func (uow *UnitOfWork) delete(obj interface{}) {
    fmt.Printf("Deleting: %T\n", obj)
}

func (uow *UnitOfWork) clear() {
    uow.newObjects = make(map[interface{}]bool)
    uow.dirtyObjects = make(map[interface{}]bool)
    uow.removedObjects = make(map[interface{}]bool)
}</code></pre>
        </div>
        
        <div class="code-snippet-panel" data-language="python">
            <pre><code># Unit of Work Pattern in Python
class UnitOfWork:
    def __init__(self):
        self.new_objects = set()
        self.dirty_objects = set()
        self.removed_objects = set()
    
    def register_new(self, obj):
        self.new_objects.add(obj)
    
    def register_dirty(self, obj):
        if obj not in self.new_objects:
            self.dirty_objects.add(obj)
    
    def register_removed(self, obj):
        self.removed_objects.add(obj)
        self.new_objects.discard(obj)
        self.dirty_objects.discard(obj)
    
    def commit(self):
        # Insert new objects
        for obj in self.new_objects:
            self._insert(obj)
        
        # Update dirty objects
        for obj in self.dirty_objects:
            self._update(obj)
        
        # Delete removed objects
        for obj in self.removed_objects:
            self._delete(obj)
        
        self._clear()
    
    def _insert(self, obj):
        print(f"Inserting: {type(obj).__name__}")
    
    def _update(self, obj):
        print(f"Updating: {type(obj).__name__}")
    
    def _delete(self, obj):
        print(f"Deleting: {type(obj).__name__}")
    
    def _clear(self):
        self.new_objects.clear()
        self.dirty_objects.clear()
        self.removed_objects.clear()

# Usage
if __name__ == "__main__":
    uow = UnitOfWork()
    user = User(1, "John", "john@example.com")
    uow.register_new(user)
    uow.commit()</code></pre>
        </div>
        
        <div class="code-snippet-panel" data-language="php">
            <pre><code>&lt;?php
// Unit of Work Pattern in PHP
class UnitOfWork {
    private $newObjects = [];
    private $dirtyObjects = [];
    private $removedObjects = [];
    
    public function registerNew($obj) {
        $this->newObjects[] = $obj;
    }
    
    public function registerDirty($obj) {
        if (!in_array($obj, $this->newObjects)) {
            $this->dirtyObjects[] = $obj;
        }
    }
    
    public function registerRemoved($obj) {
        $this->removedObjects[] = $obj;
        $this->newObjects = array_filter($this->newObjects, function($item) use ($obj) {
            return $item !== $obj;
        });
        $this->dirtyObjects = array_filter($this->dirtyObjects, function($item) use ($obj) {
            return $item !== $obj;
        });
    }
    
    public function commit() {
        // Insert new objects
        foreach ($this->newObjects as $obj) {
            $this->insert($obj);
        }
        
        // Update dirty objects
        foreach ($this->dirtyObjects as $obj) {
            $this->update($obj);
        }
        
        // Delete removed objects
        foreach ($this->removedObjects as $obj) {
            $this->delete($obj);
        }
        
        $this->clear();
    }
    
    private function insert($obj) {
        echo "Inserting: " . get_class($obj) . "\n";
    }
    
    private function update($obj) {
        echo "Updating: " . get_class($obj) . "\n";
    }
    
    private function delete($obj) {
        echo "Deleting: " . get_class($obj) . "\n";
    }
    
    private function clear() {
        $this->newObjects = [];
        $this->dirtyObjects = [];
        $this->removedObjects = [];
    }
}

// Usage
$uow = new UnitOfWork();
$user = new User(1, "John", "john@example.com");
$uow->registerNew($user);
$uow->commit();
?&gt;</code></pre>
        </div>
    </div>
</div>

<p class="note">Использована иллюстрация с сайта <a href="../martin-fowler.html">Мартина Фаулера</a></p>			<p class="note"><noindex><a href="http://martinfowler.com/eaaCatalog/unitOfWork.html">Источник</a></noindex></p>        </div>
        <div style="clear:both;margin-top: -2.5em">&nbsp;</div>
    </div>
    <ul id="footer-menu">
    	<li><a href="../index.html">Главная</a></li>
        <li><a href="index.html" title="Список шаблонов проектирования">Список паттернов</a></li>
        <li>Сайт создан и поддерживается <a href="https://vasiliy.pro">Василием Кулаковым</a>.</li>
    </ul>

   <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3BEMCB742Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3BEMCB742Q');
</script><!-- Yandex.Metrika counter -->
<div style="display:none;"><script type="text/javascript">
(function(w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
            w.yaCounter6876103 = new Ya.Metrika({id:6876103,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true});
        }
        catch(e) { }
    });
})(window, 'yandex_metrika_callbacks');
</script></div>
<script src="http://mc.yandex.ru/metrika/watch.js" type="text/javascript" defer="defer"></script>
<noscript><div><img src="http://mc.yandex.ru/watch/6876103" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

<!-- Code Snippet JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all code snippet components
    const codeSnippets = document.querySelectorAll('.code-snippet');
    
    codeSnippets.forEach(function(snippet) {
        const tabs = snippet.querySelectorAll('.code-snippet-tab');
        const panels = snippet.querySelectorAll('.code-snippet-panel');
        const copyButton = snippet.querySelector('.code-snippet-copy');
        
        // Set default active tab (JavaScript)
        const defaultTab = snippet.querySelector('[data-language="javascript"]');
        if (defaultTab) {
            defaultTab.classList.add('active');
            const defaultPanel = snippet.querySelector('.code-snippet-panel[data-language="javascript"]');
            if (defaultPanel) {
                defaultPanel.classList.add('active');
            }
        }
        
        // Tab switching functionality
        tabs.forEach(function(tab) {
            tab.addEventListener('click', function() {
                const language = this.getAttribute('data-language');
                
                // Remove active class from all tabs and panels
                tabs.forEach(t => t.classList.remove('active'));
                panels.forEach(p => p.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding panel
                this.classList.add('active');
                const targetPanel = snippet.querySelector(`.code-snippet-panel[data-language="${language}"]`);
                if (targetPanel) {
                    targetPanel.classList.add('active');
                }
            });
        });
        
        // Copy functionality
        if (copyButton) {
            copyButton.addEventListener('click', function() {
                const activePanel = snippet.querySelector('.code-snippet-panel.active');
                if (activePanel) {
                    const codeText = activePanel.textContent;
                    
                    // Copy to clipboard
                    navigator.clipboard.writeText(codeText).then(function() {
                        copyButton.textContent = 'Copied!';
                        copyButton.classList.add('copied');
                        
                        setTimeout(function() {
                            copyButton.textContent = 'Copy';
                            copyButton.classList.remove('copied');
                        }, 2000);
                    }).catch(function(err) {
                        console.error('Failed to copy text: ', err);
                    });
                }
            });
        }
    });
});
</script>
</body>
</html>